<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Validator Pro - Find Valid Email Addresses</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --background: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .card {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--surface);
            color: var(--text);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #60a5fa);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: var(--text-muted);
        }

        .results {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-header h3 {
            color: var(--text);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            box-shadow: var(--shadow);
        }

        .result-email {
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: 600;
        }

        .result-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .confidence-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .confidence-high { background: #dcfce7; color: #166534; }
        .confidence-medium { background: #fef3c7; color: #92400e; }
        .confidence-low { background: #fee2e2; color: #991b1b; }

        .pattern-badge {
            padding: 4px 8px;
            background: var(--border);
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-verified { color: var(--success); }
        .status-possible { color: var(--warning); }
        .status-invalid { color: var(--error); }

        .csv-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .csv-upload:hover {
            border-color: var(--primary);
            background: rgb(37 99 235 / 0.05);
        }

        .csv-upload.dragover {
            border-color: var(--primary);
            background: rgb(37 99 235 / 0.1);
        }

        .file-input {
            display: none;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        .notification.warning { background: var(--warning); }

        .advanced-settings {
            margin-top: 20px;
            padding: 20px;
            background: rgb(37 99 235 / 0.05);
            border-radius: 8px;
            display: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-muted);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()">
        üåì
    </div>

    <div class="container">
        <div class="header">
            <h1>Email Validator Pro</h1>
            <p>Advanced email validation and guessing platform</p>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('single')">Single Validation</button>
                <button class="tab" onclick="switchTab('bulk')">Bulk CSV Upload</button>
            </div>

            <div id="single-tab" class="tab-content active">
                <form id="emailForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" name="firstName" required placeholder="e.g., John">
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" name="lastName" required placeholder="e.g., Smith">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="domain">Company Domain *</label>
                        <input type="text" id="domain" name="domain" required placeholder="e.g., company.com">
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="advancedSettings" onchange="toggleAdvancedSettings()">
                        <label for="advancedSettings">Enable Advanced Catch-All Verification</label>
                    </div>
                    
                    <div id="advancedSettingsPanel" class="advanced-settings">
                        <p>Advanced verification includes response time analysis, pattern matching, and deliverability scoring. This may take longer but provides more accurate results for catch-all domains.</p>
                    </div>

                    <button type="submit" class="btn btn-primary" id="validateBtn">
                        <span id="validateBtnText">Validate Email Patterns</span>
                        <span id="validateSpinner" class="spinner" style="display: none;"></span>
                    </button>
                </form>
            </div>

            <div id="bulk-tab" class="tab-content">
                <div class="csv-upload" onclick="document.getElementById('csvFile').click()">
                    <input type="file" id="csvFile" class="file-input" accept=".csv" onchange="handleFileUpload(event)">
                    <div>
                        <h3>üìÅ Upload CSV File</h3>
                        <p>Drop your CSV file here or click to browse</p>
                        <p style="font-size: 14px; color: var(--text-muted); margin-top: 10px;">
                            Supported columns: firstname, lastname, domain/company (max 1MB, 100 entries)
                        </p>
                    </div>
                </div>
                <div id="csvPreview" style="display: none; margin-top: 20px;">
                    <h3>CSV Preview</h3>
                    <div id="csvPreviewTable"></div>
                    <button class="btn btn-primary" onclick="processBulkValidation()">Process Bulk Validation</button>
                </div>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Initializing validation...</div>
        </div>

        <div class="results card" id="results">
            <div class="results-header">
                <h3>Validation Results</h3>
                <div>
                    <button class="btn btn-secondary" onclick="copyResults()">üìã Copy Results</button>
                    <button class="btn btn-secondary" onclick="exportResults()">üì• Export CSV</button>
                </div>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        // Email pattern generation - 30 patterns in order of statistical frequency
        const EMAIL_PATTERNS = [
            '{first}@{domain}',
            '{f}.{last}@{domain}',
            '{first}.{last}@{domain}',
            '{f}{last}@{domain}',
            '{first}{last}@{domain}',
            '{last}@{domain}',
            '{last}.{first}@{domain}',
            '{f}_{last}@{domain}',
            '{first}_{last}@{domain}',
            '{first}-{last}@{domain}',
            '{f}-{last}@{domain}',
            '{last}{first}@{domain}',
            '{first}.{l}@{domain}',
            '{f}{l}@{domain}',
            '{first}+{last}@{domain}',
            '{first}123@{domain}',
            '{first}1@{domain}',
            '{first}.{last}1@{domain}',
            '{first}.{last}123@{domain}',
            '{last}.{f}@{domain}',
            '{last}.{first}@{domain}',
            '{last}_{first}@{domain}',
            '{first}.{f}.{last}@{domain}',
            '{first}{last}1@{domain}',
            '{first}.{last}.work@{domain}',
            '{first}.{last}.email@{domain}',
            'contact.{first}@{domain}',
            '{first}.contact@{domain}',
            'admin.{first}@{domain}',
            '{first}.admin@{domain}'
        ];

        let validationResults = [];
        let currentValidation = null;

        // Theme management
        function toggleTheme() {
            const theme = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', theme === 'dark' ? 'light' : 'dark');
            localStorage.setItem('theme', theme === 'dark' ? 'light' : 'dark');
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Advanced settings toggle
        function toggleAdvancedSettings() {
            const panel = document.getElementById('advancedSettingsPanel');
            const checkbox = document.getElementById('advancedSettings');
            panel.style.display = checkbox.checked ? 'block' : 'none';
        }

        // Generate email patterns
        function generateEmailPatterns(firstName, lastName, domain) {
            const f = firstName.toLowerCase().charAt(0);
            const l = lastName.toLowerCase().charAt(0);
            const first = firstName.toLowerCase();
            const last = lastName.toLowerCase();
            
            return EMAIL_PATTERNS.map((pattern, index) => {
                const email = pattern
                    .replace(/{first}/g, first)
                    .replace(/{last}/g, last)
                    .replace(/{f}/g, f)
                    .replace(/{l}/g, l)
                    .replace(/{domain}/g, domain);
                
                return {
                    email,
                    pattern: `Pattern ${index + 1}`,
                    patternName: pattern,
                    priority: index + 1
                };
            });
        }

        // Email validation functions
        function validateEmailSyntax(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        async function validateDomain(domain) {
            // Simulate DNS lookup with realistic delay
            await new Promise(resolve => setTimeout(resolve, 200 + Math.random() * 300));
            
            // Common valid domains for demo
            const commonDomains = ['gmail.com', 'outlook.com', 'yahoo.com', 'company.com', 'corp.com', 'business.com'];
            const isCommon = commonDomains.some(d => domain.includes(d));
            
            // Simulate 85% success rate for valid-looking domains
            return isCommon || (domain.includes('.') && Math.random() > 0.15);
        }

        async function validateSMTP(email) {
            // Simulate SMTP validation with realistic delay
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            // Simulate different response types based on email patterns
            const [localPart, domain] = email.split('@');
            
            // Common patterns more likely to be valid
            const commonPatterns = ['firstname', 'f.lastname', 'firstname.lastname'];
            const isCommonPattern = commonPatterns.some(pattern => {
                if (pattern === 'firstname') return /^[a-z]+$/.test(localPart);
                if (pattern === 'f.lastname') return /^[a-z]\.[a-z]+$/.test(localPart);
                if (pattern === 'firstname.lastname') return /^[a-z]+\.[a-z]+$/.test(localPart);
                return false;
            });
            
            // Simulate realistic success rates
            if (isCommonPattern) return Math.random() > 0.3; // 70% success for common patterns
            return Math.random() > 0.6; // 40% success for other patterns
        }

        async function detectCatchAll(domain) {
            // Simulate catch-all detection
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Simulate catch-all domains (20% chance)
            return Math.random() < 0.2;
        }

        async function advancedCatchAllVerification(email, isCatchAll) {
            if (!isCatchAll) return { confidence: 0, methods: [] };
            
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
            
            const methods = [];
            let confidence = 30; // Base confidence for catch-all
            
            // Response time analysis
            const responseTime = Math.random() * 2000 + 500;
            if (responseTime < 800) {
                confidence += 15;
                methods.push('Fast Response Time');
            }
            
            // Pattern matching
            const [localPart] = email.split('@');
            if (/^[a-z]+\.[a-z]+$/.test(localPart)) {
                confidence += 20;
                methods.push('Common Pattern Match');
            }
            
            // Reputation scoring
            if (Math.random() > 0.5) {
                confidence += 10;
                methods.push('Positive Reputation Score');
            }
            
            return { confidence: Math.min(confidence, 70), methods };
        }

        function calculateConfidence(syntaxValid, domainValid, smtpValid, isCatchAll, advancedScore) {
            if (!syntaxValid) return 0;
            if (!domainValid) return 5;
            
            if (!isCatchAll && smtpValid) return 85 + Math.random() * 15; // 85-100%
            if (!isCatchAll && !smtpValid) return 20 + Math.random() * 30; // 20-50%
            
            // Catch-all domain
            return Math.max(30, advancedScore || 30) + Math.random() * 10;
        }

        function getStatusText(confidence, isCatchAll) {
            if (confidence >= 70) return 'Verified';
            if (confidence >= 30) return isCatchAll ? 'Possible (Catch-All)' : 'Possible';
            return 'Invalid';
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 70) return 'confidence-high';
            if (confidence >= 30) return 'confidence-medium';
            return 'confidence-low';
        }

        // Main validation function
        async function validateSingleEmail(firstName, lastName, domain) {
            const patterns = generateEmailPatterns(firstName, lastName, domain);
            const results = [];
            const advancedMode = document.getElementById('advancedSettings').checked;
            
            // Show progress
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            
            for (let i = 0; i < patterns.length; i++) {
                const pattern = patterns[i];
                const progress = ((i + 1) / patterns.length) * 100;
                
                progressFill.style.width = progress + '%';
                progressText.textContent = `Validating ${pattern.email} (${i + 1}/${patterns.length})`;
                
                // Validate syntax
                const syntaxValid = validateEmailSyntax(pattern.email);
                
                // Validate domain
                const domainValid = syntaxValid ? await validateDomain(domain) : false;
                
                // SMTP validation
                const smtpValid = domainValid ? await validateSMTP(pattern.email) : false;
                
                // Catch-all detection
                const isCatchAll = domainValid ? await detectCatchAll(domain) : false;
                
                // Advanced verification
                let advancedResult = { confidence: 0, methods: [] };
                if (advancedMode && isCatchAll) {
                    advancedResult = await advancedCatchAllVerification(pattern.email, isCatchAll);
                }
                
                // Calculate final confidence
                const confidence = calculateConfidence(
                    syntaxValid, 
                    domainValid, 
                    smtpValid, 
                    isCatchAll, 
                    advancedResult.confidence
                );
                
                const result = {
                    ...pattern,
                    syntaxValid,
                    domainValid,
                    smtpValid,
                    isCatchAll,
                    confidence: Math.round(confidence),
                    status: getStatusText(confidence, isCatchAll),
                    advancedMethods: advancedResult.methods
                };
                
                results.push(result);
                
                // Show intermediate results
                displayResults(results.slice().sort((a, b) => b.confidence - a.confidence));
                
                // Small delay for visual effect
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            progressContainer.style.display = 'none';
            
            // Final results sorted by confidence
            const finalResults = results.sort((a, b) => b.confidence - a.confidence);
            displayResults(finalResults);
            showNotification('Validation completed successfully!', 'success');
            
            return finalResults;
        }

        // Display results
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');
            const statsGrid = document.getElementById('statsGrid');
            
            // Calculate stats
            const verified = results.filter(r => r.confidence >= 70).length;
            const possible = results.filter(r => r.confidence >= 30 && r.confidence < 70).length;
            const invalid = results.filter(r => r.confidence < 30).length;
            const avgConfidence = Math.round(results.reduce((sum, r) => sum + r.confidence, 0) / results.length);
            
            // Display stats
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${verified}</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${possible}</div>
                    <div class="stat-label">Possible</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${invalid}</div>
                    <div class="stat-label">Invalid</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgConfidence}%</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
            `;
            
            // Display results list
            resultsList.innerHTML = results.map(result => `
                <div class="result-item">
                    <div>
                        <div class="result-email">${result.email}</div>
                        <div style="font-size: 14px; color: var(--text-muted); margin-top: 4px;">
                            ${result.patternName} ‚Ä¢ Priority: ${result.priority}
                            ${result.advancedMethods.length > 0 ? ` ‚Ä¢ Methods: ${result.advancedMethods.join(', ')}` : ''}
                        </div>
                    </div>
                    <div class="result-details">
                        <span class="pattern-badge">${result.pattern}</span>
                        <span class="confidence-badge ${getConfidenceClass(result.confidence)}">
                            ${result.confidence}%
                        </span>
                        <span class="status-${result.status.toLowerCase().includes('verified') ? 'verified' : 
                              result.status.toLowerCase().includes('possible') ? 'possible' : 'invalid'}">
                            ${result.status}
                        </span>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
            validationResults = results;
        }

        // Form submission
        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const domain = document.getElementById('domain').value.trim();
            
            if (!firstName || !lastName || !domain) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Update button state
            const btn = document.getElementById('validateBtn');
            const btnText = document.getElementById('validateBtnText');
            const spinner = document.getElementById('validateSpinner');
            
            btn.disabled = true;
            btnText.textContent = 'Validating...';
            spinner.style.display = 'inline-block';
            
            try {
                currentValidation = await validateSingleEmail(firstName, lastName, domain);
            } catch (error) {
                showNotification('Validation failed. Please try again.', 'error');
                console.error('Validation error:', error);
            } finally {
                // Reset button state
                btn.disabled = false;
                btnText.textContent = 'Validate Email Patterns';
                spinner.style.display = 'none';
            }
        });

        // CSV handling functions
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 1024 * 1024) { // 1MB limit
                showNotification('File size must be less than 1MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length > 101) {
                        showNotification('CSV file cannot contain more than 100 entries', 'error');
                        return;
                    }
                    
                    parseCSV(csv);
                } catch (error) {
                    showNotification('Error reading CSV file', 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                showNotification('CSV must contain at least a header row and one data row', 'error');
                return;
            }
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
            const data = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                return row;
            });
            
            // Auto-detect column mappings
            const mapping = detectColumnMapping(headers);
            if (!mapping.firstName || !mapping.lastName || !mapping.domain) {
                showNotification('Unable to detect required columns (firstname, lastname, domain/company)', 'error');
                return;
            }
            
            // Preview first 5 rows
            const preview = data.slice(0, 5).map(row => ({
                firstName: row[mapping.firstName],
                lastName: row[mapping.lastName],
                domain: row[mapping.domain]
            }));
            
            displayCSVPreview(preview, data.length, mapping);
            window.csvData = data;
            window.csvMapping = mapping;
        }

        function detectColumnMapping(headers) {
            const mapping = {};
            
            // First name variations
            const firstNameOptions = ['firstname', 'first_name', 'first', 'fname', 'givenname'];
            mapping.firstName = headers.find(h => firstNameOptions.includes(h));
            
            // Last name variations
            const lastNameOptions = ['lastname', 'last_name', 'last', 'lname', 'surname', 'familyname'];
            mapping.lastName = headers.find(h => lastNameOptions.includes(h));
            
            // Domain variations
            const domainOptions = ['domain', 'company', 'email_domain', 'website', 'organization'];
            mapping.domain = headers.find(h => domainOptions.includes(h));
            
            return mapping;
        }

        function displayCSVPreview(preview, totalRows, mapping) {
            const previewDiv = document.getElementById('csvPreview');
            const tableDiv = document.getElementById('csvPreviewTable');
            
            const table = `
                <div style="margin-bottom: 15px;">
                    <strong>Detected Columns:</strong><br>
                    First Name: ${mapping.firstName}<br>
                    Last Name: ${mapping.lastName}<br>
                    Domain: ${mapping.domain}<br>
                    <strong>Total Rows:</strong> ${totalRows}
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background: var(--border);">
                            <th style="padding: 8px; border: 1px solid var(--border);">First Name</th>
                            <th style="padding: 8px; border: 1px solid var(--border);">Last Name</th>
                            <th style="padding: 8px; border: 1px solid var(--border);">Domain</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${preview.map(row => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid var(--border);">${row.firstName}</td>
                                <td style="padding: 8px; border: 1px solid var(--border);">${row.lastName}</td>
                                <td style="padding: 8px; border: 1px solid var(--border);">${row.domain}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${totalRows > 5 ? `<p style="font-style: italic; margin-top: 10px;">Showing first 5 of ${totalRows} rows</p>` : ''}
            `;
            
            tableDiv.innerHTML = table;
            previewDiv.style.display = 'block';
        }

        async function processBulkValidation() {
            if (!window.csvData || !window.csvMapping) {
                showNotification('No CSV data loaded', 'error');
                return;
            }
            
            const data = window.csvData;
            const mapping = window.csvMapping;
            const advancedMode = document.getElementById('advancedSettings').checked;
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            
            let allResults = [];
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const firstName = row[mapping.firstName];
                const lastName = row[mapping.lastName];
                const domain = row[mapping.domain];
                
                if (!firstName || !lastName || !domain) continue;
                
                const progress = ((i + 1) / data.length) * 100;
                progressFill.style.width = progress + '%';
                progressText.textContent = `Processing ${firstName} ${lastName} (${i + 1}/${data.length})`;
                
                // Generate patterns for this person
                const patterns = generateEmailPatterns(firstName, lastName, domain);
                
                // Validate top 10 patterns for bulk processing (to save time)
                const topPatterns = patterns.slice(0, 10);
                
                for (const pattern of topPatterns) {
                    const syntaxValid = validateEmailSyntax(pattern.email);
                    const domainValid = syntaxValid ? await validateDomain(domain) : false;
                    const smtpValid = domainValid ? await validateSMTP(pattern.email) : false;
                    const isCatchAll = domainValid ? await detectCatchAll(domain) : false;
                    
                    let advancedResult = { confidence: 0, methods: [] };
                    if (advancedMode && isCatchAll) {
                        advancedResult = await advancedCatchAllVerification(pattern.email, isCatchAll);
                    }
                    
                    const confidence = calculateConfidence(
                        syntaxValid, domainValid, smtpValid, isCatchAll, advancedResult.confidence
                    );
                    
                    const result = {
                        ...pattern,
                        firstName,
                        lastName,
                        domain,
                        syntaxValid,
                        domainValid,
                        smtpValid,
                        isCatchAll,
                        confidence: Math.round(confidence),
                        status: getStatusText(confidence, isCatchAll),
                        advancedMethods: advancedResult.methods
                    };
                    
                    allResults.push(result);
                }
                
                // Small delay between people
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            progressContainer.style.display = 'none';
            
            // Sort all results by confidence
            const finalResults = allResults.sort((a, b) => b.confidence - a.confidence);
            displayBulkResults(finalResults);
            showNotification(`Bulk validation completed! Processed ${data.length} entries`, 'success');
            
            validationResults = finalResults;
        }

        function displayBulkResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');
            const statsGrid = document.getElementById('statsGrid');
            
            // Calculate stats
            const verified = results.filter(r => r.confidence >= 70).length;
            const possible = results.filter(r => r.confidence >= 30 && r.confidence < 70).length;
            const invalid = results.filter(r => r.confidence < 30).length;
            const avgConfidence = Math.round(results.reduce((sum, r) => sum + r.confidence, 0) / results.length);
            const uniquePeople = new Set(results.map(r => `${r.firstName} ${r.lastName}`)).size;
            
            // Display stats
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${uniquePeople}</div>
                    <div class="stat-label">People Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${verified}</div>
                    <div class="stat-label">Verified Emails</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${possible}</div>
                    <div class="stat-label">Possible Emails</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgConfidence}%</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
            `;
            
            // Group results by person and show best email for each
            const groupedResults = {};
            results.forEach(result => {
                const key = `${result.firstName} ${result.lastName}`;
                if (!groupedResults[key] || result.confidence > groupedResults[key].confidence) {
                    groupedResults[key] = result;
                }
            });
            
            const bestResults = Object.values(groupedResults).sort((a, b) => b.confidence - a.confidence);
            
            // Display results list
            resultsList.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="showAllResults()">Show All ${results.length} Results</button>
                    <button class="btn btn-secondary" onclick="showBestResults()">Show Best Per Person (${bestResults.length})</button>
                </div>
                <div id="resultsContent">
                    ${bestResults.map(result => `
                        <div class="result-item">
                            <div>
                                <div class="result-email">${result.email}</div>
                                <div style="font-size: 14px; color: var(--text-muted); margin-top: 4px;">
                                    ${result.firstName} ${result.lastName} ‚Ä¢ ${result.patternName} 
                                    ${result.advancedMethods.length > 0 ? ` ‚Ä¢ Methods: ${result.advancedMethods.join(', ')}` : ''}
                                </div>
                            </div>
                            <div class="result-details">
                                <span class="pattern-badge">${result.pattern}</span>
                                <span class="confidence-badge ${getConfidenceClass(result.confidence)}">
                                    ${result.confidence}%
                                </span>
                                <span class="status-${result.status.toLowerCase().includes('verified') ? 'verified' : 
                                      result.status.toLowerCase().includes('possible') ? 'possible' : 'invalid'}">
                                    ${result.status}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        function showAllResults() {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = validationResults.map(result => `
                <div class="result-item">
                    <div>
                        <div class="result-email">${result.email}</div>
                        <div style="font-size: 14px; color: var(--text-muted); margin-top: 4px;">
                            ${result.firstName} ${result.lastName} ‚Ä¢ ${result.patternName}
                            ${result.advancedMethods.length > 0 ? ` ‚Ä¢ Methods: ${result.advancedMethods.join(', ')}` : ''}
                        </div>
                    </div>
                    <div class="result-details">
                        <span class="pattern-badge">${result.pattern}</span>
                        <span class="confidence-badge ${getConfidenceClass(result.confidence)}">
                            ${result.confidence}%
                        </span>
                        <span class="status-${result.status.toLowerCase().includes('verified') ? 'verified' : 
                              result.status.toLowerCase().includes('possible') ? 'possible' : 'invalid'}">
                            ${result.status}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function showBestResults() {
            const groupedResults = {};
            validationResults.forEach(result => {
                const key = `${result.firstName} ${result.lastName}`;
                if (!groupedResults[key] || result.confidence > groupedResults[key].confidence) {
                    groupedResults[key] = result;
                }
            });
            
            const bestResults = Object.values(groupedResults).sort((a, b) => b.confidence - a.confidence);
            const resultsContent = document.getElementById('resultsContent');
            
            resultsContent.innerHTML = bestResults.map(result => `
                <div class="result-item">
                    <div>
                        <div class="result-email">${result.email}</div>
                        <div style="font-size: 14px; color: var(--text-muted); margin-top: 4px;">
                            ${result.firstName} ${result.lastName} ‚Ä¢ ${result.patternName}
                            ${result.advancedMethods.length > 0 ? ` ‚Ä¢ Methods: ${result.advancedMethods.join(', ')}` : ''}
                        </div>
                    </div>
                    <div class="result-details">
                        <span class="pattern-badge">${result.pattern}</span>
                        <span class="confidence-badge ${getConfidenceClass(result.confidence)}">
                            ${result.confidence}%
                        </span>
                        <span class="status-${result.status.toLowerCase().includes('verified') ? 'verified' : 
                              result.status.toLowerCase().includes('possible') ? 'possible' : 'invalid'}">
                            ${result.status}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Utility functions
        function copyResults() {
            if (!validationResults.length) {
                showNotification('No results to copy', 'error');
                return;
            }
            
            const text = validationResults.map(result => 
                `${result.email}\t${result.confidence}%\t${result.status}\t${result.pattern}`
            ).join('\n');
            
            navigator.clipboard.writeText(`Email\tConfidence\tStatus\tPattern\n${text}`)
                .then(() => showNotification('Results copied to clipboard!', 'success'))
                .catch(() => showNotification('Failed to copy results', 'error'));
        }

        function exportResults() {
            if (!validationResults.length) {
                showNotification('No results to export', 'error');
                return;
            }
            
            const headers = ['Email', 'First Name', 'Last Name', 'Domain', 'Confidence', 'Status', 'Pattern', 'Advanced Methods'];
            const rows = validationResults.map(result => [
                result.email,
                result.firstName || '',
                result.lastName || '',
                result.domain || result.email.split('@')[1],
                result.confidence + '%',
                result.status,
                result.pattern,
                result.advancedMethods.join('; ')
            ]);
            
            const csvContent = [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `email-validation-results-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Results exported successfully!', 'success');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Drag and drop for CSV upload
        const csvUpload = document.querySelector('.csv-upload');
        
        csvUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            csvUpload.classList.add('dragover');
        });
        
        csvUpload.addEventListener('dragleave', () => {
            csvUpload.classList.remove('dragover');
        });
        
        csvUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            csvUpload.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('csvFile').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        // Initialize with sample data if needed
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-fill sample data for quick testing
            if (location.hash === '#demo') {
                document.getElementById('firstName').value = 'John';
                document.getElementById('lastName').value = 'Smith';
                document.getElementById('domain').value = 'company.com';
            }
        });
    </script>
</body>
</html>
